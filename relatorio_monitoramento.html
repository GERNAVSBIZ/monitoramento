<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Análise - Monitoramento de Pista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .metric-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; text-align: center; }
        .metric-value { font-size: 2.5rem; font-weight: 700; color: #1e40af; }
        .metric-label { font-size: 1rem; font-weight: 500; color: #6b7280; margin-top: 0.5rem; }
        .chart-container { position: relative; height: 600px; background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .filter-container { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .form-input { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; color: white; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #3b82f6; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-state" class="text-center">
        <h1 class="text-2xl font-bold text-gray-700">Carregando Relatório...</h1>
        <p class="text-gray-500">Buscando e analisando dados da planilha. Isso pode levar alguns segundos.</p>
    </div>

    <div id="report-content" class="hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Relatório de Atividade na Pista</h1>
            <p id="report-period" class="text-lg text-gray-500 mt-2"></p>
        </header>
        
        <!-- Filtros de Análise -->
        <div class="filter-container mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="start-datetime" class="block text-sm font-medium text-gray-700">Início</label>
                    <input type="datetime-local" id="start-datetime" class="form-input mt-1">
                </div>
                <div>
                    <label for="end-datetime" class="block text-sm font-medium text-gray-700">Fim</label>
                    <input type="datetime-local" id="end-datetime" class="form-input mt-1">
                </div>
                <div>
                    <label for="item-filter" class="block text-sm font-medium text-gray-700">Filtrar por Item</label>
                    <select id="item-filter" class="form-input mt-1">
                        <option value="todos">Todos os Itens</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="apply-filters-btn" class="btn btn-primary w-full">Aplicar</button>
                    <button id="clear-filters-btn" class="btn btn-secondary w-full">Limpar</button>
                </div>
            </div>
        </div>

        <!-- Métricas Principais -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card">
                <div id="total-entradas" class="metric-value">0</div>
                <div class="metric-label">Total de Entradas na Pista</div>
            </div>
            <div class="metric-card">
                <div id="item-mais-frequente" class="metric-value">N/D</div>
                <div class="metric-label">Item Mais Frequente</div>
            </div>
            <div class="metric-card">
                <div id="hora-pico" class="metric-value">00:00</div>
                <div class="metric-label">Horário de Maior Movimento</div>
            </div>
            <div class="metric-card">
                <div id="dia-pico" class="metric-value">N/D</div>
                <div class="metric-label">Dia da Semana Mais Movimentado</div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="chart-container">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Distribuição de Entradas por Tipo</h2>
                <canvas id="entradas-chart"></canvas>
            </div>
            <div class="chart-container">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Atividade por Hora do Dia</h2>
                <canvas id="horas-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzX0NsWNtFM2EfPgc2zYpWeoByt3xgjyyGsDLeB9Brt11HAULCzfCe95_ORPlHWATO2xQ/exec";

            const loadingDiv = document.getElementById('loading-state');
            const reportDiv = document.getElementById('report-content');
            
            const startDatetimeInput = document.getElementById('start-datetime');
            const endDatetimeInput = document.getElementById('end-datetime');
            const itemFilterSelect = document.getElementById('item-filter');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');

            let allProcessedData = [];
            let entradasChartInstance = null;
            let horasChartInstance = null;

            async function fetchDataAndGenerateReport() {
                try {
                    const response = await fetch(SCRIPT_URL);
                    if (!response.ok) throw new Error(`Erro na requisição: ${response.statusText}`);
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(`Erro retornado pelo script: ${result.message}`);

                    allProcessedData = result.data
                        .map(row => {
                            const match = (row.Evento || '').match(/:\s(.*?)\s(ENTROU|SAIU)/);
                            return {
                                timestamp: new Date(row.Timestamp),
                                tipo: match ? match[1] : null,
                                acao: match ? match[2] : null
                            };
                        })
                        .filter(item => item.tipo && item.acao);

                    populateItemFilter(allProcessedData);
                    updateReport(allProcessedData);

                    loadingDiv.classList.add('hidden');
                    reportDiv.classList.remove('hidden');
                } catch (error) {
                    loadingDiv.innerHTML = `<h1 class="text-2xl font-bold text-red-700">Falha ao Carregar Relatório</h1><p class="text-red-500">${error.message}</p>`;
                }
            }

            function populateItemFilter(data) {
                const uniqueItems = [...new Set(data.map(item => item.tipo))];
                uniqueItems.sort().forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    itemFilterSelect.appendChild(option);
                });
            }
            
            function applyFilters() {
                const startDate = startDatetimeInput.value ? new Date(startDatetimeInput.value) : null;
                const endDate = endDatetimeInput.value ? new Date(endDatetimeInput.value) : null;
                const selectedItem = itemFilterSelect.value;
                
                const filteredData = allProcessedData.filter(item => {
                    const isAfterStartDate = !startDate || item.timestamp >= startDate;
                    const isBeforeEndDate = !endDate || item.timestamp <= endDate;
                    const matchesItem = selectedItem === 'todos' || item.tipo === selectedItem;
                    return isAfterStartDate && isBeforeEndDate && matchesItem;
                });
                
                updateReport(filteredData);
            }
            
            function clearFilters() {
                startDatetimeInput.value = '';
                endDatetimeInput.value = '';
                itemFilterSelect.value = 'todos';
                updateReport(allProcessedData);
            }

            function updateReport(data) {
                if (!data || data.length === 0) {
                    // Limpa a tela se não houver dados após o filtro
                    document.getElementById('total-entradas').textContent = '0';
                    document.getElementById('item-mais-frequente').textContent = 'N/D';
                    document.getElementById('hora-pico').textContent = 'N/D';
                    document.getElementById('dia-pico').textContent = 'N/D';
                    document.getElementById('report-period').textContent = 'Nenhum dado encontrado para o filtro selecionado.';
                    if(entradasChartInstance) entradasChartInstance.destroy();
                    if(horasChartInstance) horasChartInstance.destroy();
                    return;
                }
                
                const entradas = data.filter(d => d.acao === 'ENTROU');
                if (entradas.length === 0) {
                     document.getElementById('report-period').textContent = "Nenhum evento de 'ENTRADA' encontrado para o filtro selecionado.";
                     if(entradasChartInstance) entradasChartInstance.destroy();
                     if(horasChartInstance) horasChartInstance.destroy();
                     return;
                }
                
                const firstDate = entradas.reduce((min, p) => p.timestamp < min ? p.timestamp : min, entradas[0].timestamp);
                const lastDate = entradas.reduce((max, p) => p.timestamp > max ? p.timestamp : max, entradas[0].timestamp);
                document.getElementById('report-period').textContent = `Análise do período de ${firstDate.toLocaleDateString('pt-BR')} a ${lastDate.toLocaleDateString('pt-BR')}`;

                document.getElementById('total-entradas').textContent = entradas.length;

                const tipoCounts = entradas.reduce((acc, curr) => {
                    acc[curr.tipo] = (acc[curr.tipo] || 0) + 1;
                    return acc;
                }, {});
                const itemMaisFrequente = Object.keys(tipoCounts).length > 0 ? Object.keys(tipoCounts).reduce((a, b) => tipoCounts[a] > tipoCounts[b] ? a : b) : 'N/D';
                document.getElementById('item-mais-frequente').textContent = itemMaisFrequente;

                const horaCounts = entradas.reduce((acc, curr) => {
                    const hour = curr.timestamp.getHours();
                    acc[hour] = (acc[hour] || 0) + 1;
                    return acc;
                }, {});
                const horaPico = Object.keys(horaCounts).length > 0 ? Object.keys(horaCounts).reduce((a, b) => horaCounts[a] > horaCounts[b] ? a : b) : -1;
                document.getElementById('hora-pico').textContent = horaPico !== -1 ? `${String(horaPico).padStart(2, '0')}:00` : 'N/D';

                const diasDaSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                const diaCounts = entradas.reduce((acc, curr) => {
                    const day = diasDaSemana[curr.timestamp.getDay()];
                    acc[day] = (acc[day] || 0) + 1;
                    return acc;
                }, {});
                 const diaPico = Object.keys(diaCounts).length > 0 ? Object.keys(diaCounts).reduce((a, b) => diaCounts[a] > diaCounts[b] ? a : b) : 'N/D';
                 document.getElementById('dia-pico').textContent = diaPico;

                generateEntradasChart(tipoCounts);
                generateHorasChart(horaCounts);
            }
            
            function generateEntradasChart(tipoCounts) {
                if(entradasChartInstance) entradasChartInstance.destroy();
                const ctx = document.getElementById('entradas-chart').getContext('2d');
                entradasChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(tipoCounts),
                        datasets: [{
                            label: 'Nº de Entradas',
                            data: Object.values(tipoCounts),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6b7280'],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            function generateHorasChart(horaCounts) {
                 if(horasChartInstance) horasChartInstance.destroy();
                 const ctx = document.getElementById('horas-chart').getContext('2d');
                 const labels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`);
                 const data = labels.map((label, index) => horaCounts[index] || 0);

                 horasChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nº de Entradas',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
            
            applyFiltersBtn.addEventListener('click', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);

            fetchDataAndGenerateReport();
        });
    </script>

</body>
</html>

